<?phprequire("header.php");if(!isset($_GET['sp'])) {if(!isset($_GET['user'])) {if(isset($_GET['limit']))$limit=$_GET['limit'];else$limit=1000;$m=messages_getusers($_GET['name'], $limit);$cnt=0;$txt="\r\n".((count($m)>$limit)?1:0);foreach($m as $s) {if($cnt>=$limit) break;++$cnt;$txt .= "\r\n".$s['user']."\r\n".$s['last']."\r\n".$s['date']."\r\n".$s['subj']."\r\n".$s['read']."\r\n".$s['id'];if(isset($_GET['details']) && $_GET['details']==1)$txt.="\r\n".(int)$s['muted'];}echo "0\r\n".$cnt.$txt;//die;}elseif(isset($_GET['user']) and (!isset($_GET['subj']) and !isset($_GET['id']))) {if(isset($_GET['limit']))$limit=(int)$_GET['limit'];else$limit=1000;$m=messages_getconversations($_GET['name'], $_GET['user'], $limit);$cnt=0;$txt=((count($m)>$limit)?1:0)."\r\n";if(mysql_num_rows(mquery("select name from users where name='".mysql_real_escape_string($_GET['user'])."'"))>0)$txt.="1";else$txt.="0";foreach($m as $s) {if($cnt>=$limit) break;++$cnt;$txt .= "\r\n".$s['subj']."\r\n".$s['last']."\r\n".$s['date']."\r\n".$s['read']."\r\n".$s['id'];}echo "0\r\n".$cnt."\r\n".$txt;}elseif(isset($_GET['user']) and (isset($_GET['subj']) or isset($_GET['id']))) {if(isset($_GET['subj']))$subj=$_GET['subj'];else$subj=mysql_fetch_row(mquery("select replace(lower(subject), 're: ', '') from messages where id='".(int)$_GET['id']."'"))[0];if(isset($_GET['limit']))$limit=$_GET['limit'];else$limit=1000;$m=messages_getmessages($_GET['name'], $_GET['user'], $subj, $limit);$txt="\r\n".((count($m)>$limit)?1:0)."\r\n";if(mysql_num_rows(mquery("select name from users where name='".mysql_real_escape_string($_GET['user'])."'"))>0 or mysql_num_rows(mquery("select id from messages_groups where id='".mysql_real_escape_string($_GET['user'])."'"))>0)$txt.="1";else$txt.="0";$cnt=0;foreach($m as $s) {if($cnt>=$limit) break;++$cnt;if(strpos($_GET['user'],"[")===0 && $s['read']==0)mquery("insert into messages_read (message,user,time) values (".(int)$s['id'].", '".mysql_real_escape_string($_GET['name'])."', unix_timestamp())");if(!isset($_GET['details']) || $_GET['details']==0)$txt .= "\r\n".$s['id']."\r\n".$s['sender']."\r\n".$s['subj']."\r\n".$s['date']."\r\n".$s['read']."\r\n".$s['marked']."\r\n".$s['attachments']."\r\n".$s['message']."\r\n\004END\004";else$txt .= "\r\n".$s['id']."\r\n".$s['sender']."\r\n".$s['subj']."\r\n".$s['date']."\r\n".(int)($s['read']>0)."\r\n".$s['marked']."\r\n".$s['attachments']."\r\n".$s['protected']."\r\n".$s['message']."\r\n\004END\004";}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and sender='".mysql_real_escape_string($_GET['user'])."' and receiver='".mysql_real_escape_string($_GET['name'])."' and replace(lower(subject), 're: ', '')=lower('".mysql_real_escape_String($subj)."')");}}else {switch($_GET['sp']) {case "new": {$q=mquery("select replace(lower(subject),'re: ','') as subject, if(receiver not like '[%]', sender, receiver) as user, date, 1, id from messages where id in (select max(id) from messages where (((receiver='".mysql_real_escape_string($_GET['name'])."') and `read` is null) or (receiver in (select groupid from messages_groups_members where user='".mysql_real_escape_string($_GET['name'])."') and id not in (select message from messages_read where user='".mysql_real_escape_string($_GET['name'])."'))) group by replace(lower(subject), 're: ', ''),sender) and (((receiver='".mysql_real_escape_string($_GET['name'])."') and `read` is null) or (receiver in (select groupid from messages_groups_members where user='".mysql_real_escape_string($_GET['name'])."') and id not in (select message from messages_read where user='".mysql_real_escape_string($_GET['name'])."'))) group by replace(lower(subject), 're: ', ''),user order by id desc");$txt="0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4];++$cnt;}echo "0\r\n".$cnt."\r\n".$txt;break;}case "flagged": {$q=mquery("select id, sender, subject, date, if(`read` is not null, 1, 0), marked, attachments, message from messages where receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0 and marked=1 order by id desc");$txt="\r\n0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5]."\r\n".$r[6]."\r\n".$r[7]."\r\n\004END\004";++$cnt;}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and receiver='".mysql_real_escape_string($_GET['name'])."' and marked=1");break;
}case "search": {$q=mquery("select id, sender, subject, date, if(`read` is not null, 1, 0), marked, attachments, message from messages where receiver='".mysql_real_escape_string($_GET['name'])."' and deletedfromreceived=0 and lower(message) like '%".mysql_real_escape_string($_GET['search'])."%' order by id desc limit 0,100");$txt="\r\n0\r\n";$txt.="0";$cnt=0;while($r=mysql_fetch_row($q)) {$txt.="\r\n".$r[0]."\r\n".$r[1]."\r\n".$r[2]."\r\n".$r[3]."\r\n".$r[4]."\r\n".$r[5]."\r\n".$r[6]."\r\n".$r[7]."\r\n\004END\004";++$cnt;}echo "0\r\n".$cnt.$txt;mquery("update messages set `read`=".time()." where `read` is null and receiver='".mysql_real_escape_string($_GET['name'])."' and lower(message) like '%".mysql_real_escape_string($_GET['search'])."%' order by id desc limit 100");
break;}}}?>